name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ìë™ ì˜ˆì•½ v3.1

on:
  schedule:
    # í•œêµ­ì‹œê°„ 23:45 (UTC 14:45) - GitHub Actions ì§€ì—°ì„ ê³ ë ¤í•˜ì—¬ 15ë¶„ ì•ë‹¹ê¹€
    # ì‹¤ì œ ì˜ˆì•½ ì‹¤í–‰ì€ ìì •(00:00~00:15) ì‚¬ì´ì— ì´ë£¨ì–´ì§
    - cron: '45 14 * * *'  # UTC 14:45 = KST 23:45
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì‹¤ì œ ì˜ˆì•½í•˜ì§€ ì•ŠìŒ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      force_weekend:
        description: 'ì£¼ë§ì—ë„ ê°•ì œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-weekday:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      target_date: ${{ steps.check.outputs.target_date }}
      day_name: ${{ steps.check.outputs.day_name }}
    steps:
    - name: ğŸ“… ì£¼ë§ ì²´í¬ (KST ê¸°ì¤€)
      id: check
      run: |
        # í˜„ì¬ UTC ì‹œê°„ì„ KSTë¡œ ë³€í™˜í•˜ì—¬ 7ì¼ í›„ ê³„ì‚°
        echo "í˜„ì¬ UTC: $(date -u)"
        
        # KST ê¸°ì¤€ í˜„ì¬ ì‹œê°„ (UTC + 9ì‹œê°„)
        current_kst=$(TZ='Asia/Seoul' date)
        echo "í˜„ì¬ KST: $current_kst"
        
        # KST ê¸°ì¤€ í˜„ì¬ ìš”ì¼ í™•ì¸
        current_day=$(TZ='Asia/Seoul' date '+%u')
        current_day_name=$(TZ='Asia/Seoul' date '+%A')
        echo "í˜„ì¬ ìš”ì¼: $current_day_name (ìˆ«ì: $current_day)"
        
        # KST ê¸°ì¤€ 7ì¼ í›„ ë‚ ì§œ ê³„ì‚°
        target_date=$(TZ='Asia/Seoul' date -d '+7 days' '+%Y-%m-%d')
        target_day=$(TZ='Asia/Seoul' date -d '+7 days' '+%u') # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
        day_name_en=$(TZ='Asia/Seoul' date -d '+7 days' '+%A')
        
        # í•œêµ­ì–´ ìš”ì¼ ë³€í™˜
        case $day_name_en in
          "Monday") day_name="ì›”ìš”ì¼" ;;
          "Tuesday") day_name="í™”ìš”ì¼" ;;
          "Wednesday") day_name="ìˆ˜ìš”ì¼" ;;
          "Thursday") day_name="ëª©ìš”ì¼" ;;
          "Friday") day_name="ê¸ˆìš”ì¼" ;;
          "Saturday") day_name="í† ìš”ì¼" ;;
          "Sunday") day_name="ì¼ìš”ì¼" ;;
          *) day_name=$day_name_en ;;
        esac
        
        echo "ğŸ¯ ì˜ˆì•½ ëŒ€ìƒ ë‚ ì§œ: $target_date ($day_name)"
        echo "ğŸ“Š ì˜ˆì•½ ëŒ€ìƒ ìš”ì¼ ìˆ«ì: $target_day (1=ì›”, 7=ì¼)"
        
        # ì£¼ë§ ì²´í¬ (í† ìš”ì¼=6, ì¼ìš”ì¼=7)
        force_weekend="${{ github.event.inputs.force_weekend }}"
        if [[ "$target_day" == "6" || "$target_day" == "7" ]]; then
          if [[ "$force_weekend" == "true" ]]; then
            echo "âš ï¸ ì£¼ë§ì´ì§€ë§Œ ê°•ì œ ì‹¤í–‰ ì˜µì…˜ í™œì„±í™”"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸš« ì£¼ë§($day_name)ì´ë¯€ë¡œ ì˜ˆì•½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âœ… í‰ì¼($day_name) í™•ì¸ - ì˜ˆì•½ ì§„í–‰"
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi
        
        echo "target_date=$target_date" >> $GITHUB_OUTPUT
        echo "day_name=$day_name" >> $GITHUB_OUTPUT

  pilates-booking:
    needs: check-weekday
    runs-on: ubuntu-latest
    # ì•ˆì „ì¥ì¹˜: check-weekdayë§Œ ì„±ê³µí•˜ë©´ ì‹¤í–‰ (wait job ì˜ì¡´ì„± ì œê±°)
    if: needs.check-weekday.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
    
    - name: â° ìŠ¤ë§ˆíŠ¸ íƒ€ì´ë° ì œì–´
      id: timing
      run: |
        echo "â° íƒ€ì´ë° ì œì–´ ì‹œì‘"
        
        # í˜„ì¬ KST ì‹œê°„ í™•ì¸
        current_hour=$(TZ='Asia/Seoul' date '+%H')
        current_minute=$(TZ='Asia/Seoul' date '+%M')
        current_time=$(TZ='Asia/Seoul' date '+%H:%M:%S')
        
        echo "ğŸ“Š í˜„ì¬ KST ì‹œê°„: $current_time"
        echo "ğŸ“Š ì‹œê°„: ${current_hour}ì‹œ ${current_minute}ë¶„"
        
        # ìµœì  ì‹¤í–‰ ì‹œê°„ ì²´í¬ ë° ëŒ€ê¸°
        if [[ "$current_hour" == "23" && "$current_minute" -ge "45" ]]; then
          echo "ğŸ•š 23:45 ì´í›„ - ìì •ê¹Œì§€ ëŒ€ê¸°"
          
          # ìµœëŒ€ 20ë¶„ ëŒ€ê¸° (ì•ˆì „ì¥ì¹˜)
          max_iterations=40  # 30ì´ˆ * 40 = 20ë¶„
          iteration=0
          
          while [[ $iteration -lt $max_iterations ]]; do
            now_hour=$(TZ='Asia/Seoul' date '+%H')
            now_minute=$(TZ='Asia/Seoul' date '+%M')
            now_second=$(TZ='Asia/Seoul' date '+%S')
            
            echo "â³ í˜„ì¬: ${now_hour}:${now_minute}:${now_second} (${iteration}/${max_iterations})"
            
            # 00:00~00:15 ì‚¬ì´ë©´ ì¦‰ì‹œ ì‹œì‘
            if [[ "$now_hour" == "00" && "$now_minute" -le "15" ]]; then
              echo "ğŸ¯ ìµœì  ì‹œê°„ ë„ë‹¬! ì˜ˆì•½ ì‹œì‘ (${now_hour}:${now_minute})"
              break
            fi
            
            # 30ì´ˆ ëŒ€ê¸°
            sleep 30
            iteration=$((iteration + 1))
          done
          
          if [[ $iteration -ge $max_iterations ]]; then
            echo "âš ï¸ ìµœëŒ€ ëŒ€ê¸° ì‹œê°„(20ë¶„) ì´ˆê³¼ - ê°•ì œ ì‹œì‘"
          fi
          
        elif [[ "$current_hour" == "00" && "$current_minute" -le "30" ]]; then
          echo "ğŸ¯ ì´ë¯¸ ìµœì  ì‹œê°„ëŒ€ (00:00~00:30) - ë°”ë¡œ ì‹œì‘"
          
        elif [[ "$current_hour" == "23" && "$current_minute" -ge "30" ]]; then
          echo "ğŸ¯ ì ì ˆí•œ ì‹œê°„ëŒ€ (23:30~23:44) - ë°”ë¡œ ì‹œì‘"
          
        else
          echo "âš ï¸ ì˜ˆìƒ ë°– ì‹œê°„ëŒ€: ${current_hour}:${current_minute}"
          echo "âš ï¸ ì •ìƒ ì‹¤í–‰ ì‹œê°„: 23:30~00:30"
          echo "âš ï¸ ê·¸ë˜ë„ ì˜ˆì•½ì„ ì§„í–‰í•©ë‹ˆë‹¤ (fallback)"
        fi
        
        final_time=$(TZ='Asia/Seoul' date '+%H:%M:%S')
        echo "âœ… ì˜ˆì•½ ì‹œì‘ ì‹œê°„: $final_time"
        echo "start_time=$final_time" >> $GITHUB_OUTPUT
    
    - name: ğŸ” í™˜ê²½ í™•ì¸
      run: |
        echo "ğŸ“Š ì‹¤í–‰ í™˜ê²½:"
        echo "- Node.js: $(node --version)"
        echo "- npm: $(npm --version)"
        echo "- íƒ€ì„ì¡´: $(date)"
        echo "- KST: $(TZ='Asia/Seoul' date)"
        echo "- ì˜ˆì•½ ì‹œì‘ ì‹œê°„: ${{ steps.timing.outputs.start_time }}"
        echo "- ì˜ˆì•½ ë‚ ì§œ: ${{ needs.check-weekday.outputs.target_date }}"
        echo "- ìš”ì¼: ${{ needs.check-weekday.outputs.day_name }}"
        echo "- í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode }}"
    
    - name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ì‹¤í–‰
      env:
        PILATES_USERNAME: ${{ secrets.PILATES_USERNAME }}
        PILATES_PASSWORD: ${{ secrets.PILATES_PASSWORD }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
        GITHUB_ACTIONS: true
        CI: true
      run: |
        echo "ğŸ¯ ì˜ˆì•½ ì‹¤í–‰ ì‹œì‘ - KST: $(TZ='Asia/Seoul' date '+%H:%M:%S')"
        
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          echo "âš ï¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘..."
          npm run book:test
        else
          echo "ğŸ¯ ì‹¤ì œ ì˜ˆì•½ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘..."
          npm run book
        fi
        
        echo "âœ… ì˜ˆì•½ ì™„ë£Œ - KST: $(TZ='Asia/Seoul' date '+%H:%M:%S')"
    
    - name: ğŸ“‹ ê²°ê³¼ í™•ì¸
      if: always()
      run: |
        echo "ğŸ“Š ì˜ˆì•½ ê²°ê³¼:"
        echo "ğŸ“Š ì™„ë£Œ ì‹œê°„: $(TZ='Asia/Seoul' date '+%H:%M:%S')"
        
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          if [ -f "test-result.json" ]; then
            echo "âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ìƒì„±ë¨"
            cat test-result.json
          else
            echo "âŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          fi
        else
          if [ -f "booking-result.json" ]; then
            echo "âœ… ì˜ˆì•½ ê²°ê³¼ íŒŒì¼ ìƒì„±ë¨"
            cat booking-result.json
          else
            echo "âŒ ì˜ˆì•½ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          fi
        fi
        
        echo ""
        echo "ğŸ“ ë¡œê·¸ íŒŒì¼:"
        if [ -d "logs" ]; then
          ls -la logs/
          if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
            if [ -f "logs/test.log" ]; then
              echo "=== í…ŒìŠ¤íŠ¸ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„) ==="
              tail -20 logs/test.log
            fi
          else
            if [ -f "logs/booking.log" ]; then
              echo "=== ì˜ˆì•½ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„) ==="
              tail -20 logs/booking.log
            fi
          fi
        fi
    
    - name: ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-screenshots-${{ github.run_number }}
        path: |
          screenshots/
          logs/
          booking-result.json
          test-result.json
        retention-days: 7
        if-no-files-found: ignore

  weekend-skip:
    needs: check-weekday
    runs-on: ubuntu-latest
    if: needs.check-weekday.outputs.should_run == 'false'
    
    steps:
    - name: ğŸš« ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
      run: |
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ ë‚ ì§œ: ${{ needs.check-weekday.outputs.target_date }}"
        echo "ğŸ“† ìš”ì¼: ${{ needs.check-weekday.outputs.day_name }}"
        echo "ğŸš« ì£¼ë§ì´ë¯€ë¡œ ì˜ˆì•½ì„ ê±´ë„ˆëœë‹ˆë‹¤."
        echo "ğŸ’¡ ì£¼ë§ì—ë„ ì‹¤í–‰í•˜ë ¤ë©´ 'force_weekend' ì˜µì…˜ì„ trueë¡œ ì„¤ì •í•˜ì„¸ìš”."
