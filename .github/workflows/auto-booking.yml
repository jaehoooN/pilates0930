name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ìë™ ì˜ˆì•½ v6.1 (ì£¼ë§ ë¡œì§ ìˆ˜ì • + ë‹¨ìˆœí™”)

on:
  schedule:
    # ë§¤ì¼ 23:55ì— ì‹¤í–‰ (ë‹¨ì¼ ìŠ¤ì¼€ì¤„ë¡œ í†µí•©)
    - cron: '55 14 * * *'  # 23:55 KST - ë©”ì¸ ì‹¤í–‰
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'      # ìë™ íŒë‹¨
          - 'force'     # ê°•ì œ ì‹¤í–‰
          - 'test'      # í…ŒìŠ¤íŠ¸ ëª¨ë“œ
          - 'immediate' # ì¦‰ì‹œ ì‹¤í–‰ (ëŒ€ê¸° ì—†ìŒ)
      target_time:
        description: 'ëª©í‘œ ì‹¤í–‰ ì‹œê°„ (KST, ì˜ˆ: 00:01:00)'
        required: false
        default: '00:01:00'
        type: string

env:
  NODE_VERSION: '20'
  TIMEZONE: 'Asia/Seoul'
  PUPPETEER_SKIP_DOWNLOAD: 'true'
  PUPPETEER_EXECUTABLE_PATH: '/usr/bin/google-chrome-stable'

jobs:
  # ì‹¤í–‰ ì¡°ê±´ íŒë‹¨ (ìˆ˜ì •ë¨)
  orchestrator:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
      execution_mode: ${{ steps.decision.outputs.execution_mode }}
      target_date: ${{ steps.decision.outputs.target_date }}
      target_time: ${{ steps.decision.outputs.target_time }}
      wait_minutes: ${{ steps.decision.outputs.wait_minutes }}
      skip_reason: ${{ steps.decision.outputs.skip_reason }}
      current_time: ${{ steps.decision.outputs.current_time }}
    
    steps:
    - name: ğŸ“Š ì‹¤í–‰ ì¡°ê±´ ë¶„ì„ (ì£¼ë§ ë¡œì§ ìˆ˜ì •)
      id: decision
      run: |
        echo "=== ğŸ“Š ì›Œí¬í”Œë¡œìš° ë¶„ì„ v6.1 ==="
        
        # í˜„ì¬ KST ì‹œê°„
        current_kst=$(TZ='${{ env.TIMEZONE }}' date '+%Y-%m-%d %H:%M:%S')
        current_hour=$(TZ='${{ env.TIMEZONE }}' date '+%H')
        current_minute=$(TZ='${{ env.TIMEZONE }}' date '+%M')
        current_day=$(TZ='${{ env.TIMEZONE }}' date '+%u')  # 1=ì›”, 7=ì¼
        
        echo "í˜„ì¬ KST: $current_kst"
        echo "í˜„ì¬ ìš”ì¼: $current_day (1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼)"
        echo "current_time=${current_hour}:${current_minute}" >> $GITHUB_OUTPUT
        
        # ìˆ˜ë™ ì‹¤í–‰ ì—¬ë¶€
        workflow_dispatch="${{ github.event_name == 'workflow_dispatch' }}"
        mode="${{ github.event.inputs.mode || 'auto' }}"
        target_time="${{ github.event.inputs.target_time || '00:01:00' }}"
        
        # 7ì¼ í›„ ë‚ ì§œ ê³„ì‚°
        target_date=$(TZ='${{ env.TIMEZONE }}' date -d '+7 days' '+%Y-%m-%d')
        target_day=$(TZ='${{ env.TIMEZONE }}' date -d '+7 days' '+%u')
        
        echo "target_date=$target_date" >> $GITHUB_OUTPUT
        echo "target_time=$target_time" >> $GITHUB_OUTPUT
        echo "ğŸ“… 7ì¼ í›„ ì˜ˆì•½ ëŒ€ìƒ: $target_date (ìš”ì¼: $target_day)"
        
        # ì‹¤í–‰ ì—¬ë¶€ ê²°ì • (ì£¼ë§ ë¡œì§ ìˆ˜ì •!)
        should_run="false"
        execution_mode="skip"
        skip_reason=""
        wait_minutes="6"  # ì•½ 6ë¶„ ëŒ€ê¸° (23:55 â†’ 00:01)
        
        # í•µì‹¬ ë¡œì§: í˜„ì¬ ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
        # ê¸ˆìš”ì¼(5) 23:55 â†’ í† ìš”ì¼ ì˜ˆì•½ â†’ ìŠ¤í‚µ
        # í† ìš”ì¼(6) 23:55 â†’ ì¼ìš”ì¼ ì˜ˆì•½ â†’ ìŠ¤í‚µ  
        # ì¼ìš”ì¼(7) 23:55 â†’ ì›”ìš”ì¼ ì˜ˆì•½ â†’ ì‹¤í–‰
        # í‰ì¼(1-4) 23:55 â†’ í‰ì¼ ì˜ˆì•½ â†’ ì‹¤í–‰
        
        if [[ "$workflow_dispatch" == "true" ]]; then
          # ìˆ˜ë™ ì‹¤í–‰
          if [[ "$mode" == "force" ]]; then
            should_run="true"
            execution_mode="manual-force"
            echo "ğŸ”§ ìˆ˜ë™ ê°•ì œ ì‹¤í–‰ ëª¨ë“œ"
          elif [[ "$mode" == "test" ]]; then
            should_run="true"
            execution_mode="test"
            echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ"
          elif [[ "$mode" == "immediate" ]]; then
            should_run="true"
            execution_mode="immediate"
            wait_minutes="0"
            echo "ğŸš€ ì¦‰ì‹œ ì‹¤í–‰ ëª¨ë“œ"
          else
            # auto ëª¨ë“œ - ìš”ì¼ ì²´í¬
            if [[ "$current_day" -eq 5 ]] || [[ "$current_day" -eq 6 ]]; then
              skip_reason="ê¸ˆ/í† ìš”ì¼ì€ ì£¼ë§ ì˜ˆì•½ì´ë¯€ë¡œ ìŠ¤í‚µ"
              echo "ğŸš« $skip_reason"
            else
              should_run="true"
              execution_mode="manual-auto"
            fi
          fi
        else
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ - ìš”ì¼ ì²´í¬
          if [[ "$current_day" -eq 5 ]]; then
            skip_reason="ê¸ˆìš”ì¼ â†’ í† ìš”ì¼ ì˜ˆì•½ ìŠ¤í‚µ"
            echo "ğŸš« $skip_reason"
          elif [[ "$current_day" -eq 6 ]]; then
            skip_reason="í† ìš”ì¼ â†’ ì¼ìš”ì¼ ì˜ˆì•½ ìŠ¤í‚µ"
            echo "ğŸš« $skip_reason"
          else
            # ì¼ìš”ì¼(7) ë˜ëŠ” í‰ì¼(1-4)
            should_run="true"
            execution_mode="scheduled"
            echo "âœ… í‰ì¼ ì˜ˆì•½ ì§„í–‰ (ì¼ìš”ì¼â†’ì›”ìš”ì¼ í¬í•¨)"
          fi
        fi
        
        echo "should_run=$should_run" >> $GITHUB_OUTPUT
        echo "execution_mode=$execution_mode" >> $GITHUB_OUTPUT
        echo "wait_minutes=$wait_minutes" >> $GITHUB_OUTPUT
        echo "skip_reason=$skip_reason" >> $GITHUB_OUTPUT
        
        echo "âœ… ë¶„ì„ ì™„ë£Œ:"
        echo "  - ì‹¤í–‰ ì—¬ë¶€: $should_run"
        echo "  - ì‹¤í–‰ ëª¨ë“œ: $execution_mode"
        echo "  - ëŒ€ê¸° ì‹œê°„: ${wait_minutes}ë¶„"
        if [[ "$should_run" == "false" ]]; then
          echo "  - ìŠ¤í‚µ ì´ìœ : $skip_reason"
        fi

  # ë©”ì¸ ì˜ˆì•½ ì‹¤í–‰
  booking-execution:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: needs.orchestrator.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì í™”)
      run: |
        npm install --package-lock-only
        npm ci --prefer-offline --no-audit --no-fund --progress=false

    - name: â° ì •ë°€ ëŒ€ê¸° (00:01ê¹Œì§€)
      id: timing
      run: |
        wait_minutes="${{ needs.orchestrator.outputs.wait_minutes }}"
        target_time="${{ needs.orchestrator.outputs.target_time }}"
        
        echo "â° ëŒ€ê¸° ì‹œê°„: ${wait_minutes}ë¶„"
        echo "ğŸ¯ ëª©í‘œ ì‹œê°„: $target_time"
        
        if [[ "$wait_minutes" -gt 0 ]]; then
          # ëª©í‘œ ì‹œê°„ íŒŒì‹±
          IFS=':' read -r target_hour target_minute target_second <<< "$target_time"
          target_hour=${target_hour:-0}
          target_minute=${target_minute:-1}
          target_second=${target_second:-0}
          
          echo "â³ ëª©í‘œ ì‹œê°„ê¹Œì§€ ëŒ€ê¸° ì‹œì‘..."
          
          # ë¶„ ë‹¨ìœ„ ëŒ€ê¸°
          for ((i=wait_minutes; i>1; i--)); do
            echo "â³ ${i}ë¶„ ë‚¨ìŒ..."
            sleep 60
          done
          
          # ë§ˆì§€ë§‰ 1ë¶„ì€ ì´ˆ ë‹¨ìœ„ ì •ë°€ ì œì–´
          echo "ğŸ¯ ë§ˆì§€ë§‰ 1ë¶„ - ì´ˆ ë‹¨ìœ„ ì •ë°€ ì œì–´"
          while true; do
            current_hour=$(TZ='${{ env.TIMEZONE }}' date '+%-H')
            current_minute=$(TZ='${{ env.TIMEZONE }}' date '+%-M')
            current_second=$(TZ='${{ env.TIMEZONE }}' date '+%-S')
            
            # ëª©í‘œ ì‹œê°„ ë„ë‹¬ í™•ì¸
            if [[ "$current_hour" -eq "$target_hour" ]] && \
               [[ "$current_minute" -eq "$target_minute" ]] && \
               [[ "$current_second" -ge "$target_second" ]]; then
              break
            fi
            
            # ëª©í‘œ ì‹œê°„ ê²½ê³¼ í™•ì¸
            current_total=$((current_hour * 3600 + current_minute * 60 + current_second))
            target_total=$((target_hour * 3600 + target_minute * 60 + target_second))
            
            if [[ "$current_hour" -gt 0 ]] && [[ "$target_hour" -eq 0 ]]; then
              # ìì •ì„ ë„˜ì–´ê°„ ê²½ìš° ì²˜ë¦¬
              break
            elif [[ $current_total -gt $target_total ]]; then
              echo "âš ï¸ ëª©í‘œ ì‹œê°„ ê²½ê³¼ - ì¦‰ì‹œ ì‹¤í–‰"
              break
            fi
            
            remaining=$((target_total - current_total))
            if [[ $remaining -le 10 ]] && [[ $remaining -gt 0 ]]; then
              echo "ğŸ”¥ ${remaining}ì´ˆ..."
            fi
            
            sleep 1
          done
        fi
        
        final_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')
        echo "ğŸš€ ì˜ˆì•½ ì‹¤í–‰ ì‹œì‘: $final_time"

    - name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ì‹¤í–‰
      env:
        PILATES_USERNAME: ${{ secrets.PILATES_USERNAME }}
        PILATES_PASSWORD: ${{ secrets.PILATES_PASSWORD }}
        TEST_MODE: ${{ needs.orchestrator.outputs.execution_mode == 'test' && 'true' || 'false' }}
        IMMEDIATE_MODE: ${{ needs.orchestrator.outputs.execution_mode == 'immediate' && 'true' || 'false' }}
        EXECUTION_MODE: ${{ needs.orchestrator.outputs.execution_mode }}
        TARGET_TIME: ${{ needs.orchestrator.outputs.target_time }}
        GITHUB_ACTIONS: 'true'
      run: |
        echo "ğŸš€ í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ì‹¤í–‰"
        echo "ğŸ“Š ì‹¤í–‰ ëª¨ë“œ: $EXECUTION_MODE"
        
        timeout 600 npm run book || {
          exit_code=$?
          if [[ $exit_code -eq 124 ]]; then
            echo "â° íƒ€ì„ì•„ì›ƒ (10ë¶„)"
          else
            echo "âŒ ì‹¤í–‰ ì‹¤íŒ¨ (ì½”ë“œ: $exit_code)"
          fi
          exit $exit_code
        }

    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„
      if: always()
      run: |
        result_file="booking-result.json"
        if [[ "${{ needs.orchestrator.outputs.execution_mode }}" == "test" ]]; then
          result_file="test-result.json"
        fi
        
        if [ -f "$result_file" ]; then
          echo "ğŸ“„ ê²°ê³¼:"
          cat "$result_file" | jq '.' 2>/dev/null || cat "$result_file"
        else
          echo "âŒ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          exit 1
        fi

    - name: ğŸ“¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-results-${{ github.run_number }}
        path: |
          screenshots/
          logs/
          *.json
        retention-days: 3
        if-no-files-found: ignore

  # ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
  weekend-notification:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: needs.orchestrator.outputs.should_run == 'false'
    
    steps:
    - name: ğŸš« ìŠ¤í‚µ ì•Œë¦¼
      run: |
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ: ${{ needs.orchestrator.outputs.target_date }}"
        echo "ğŸš« ìŠ¤í‚µ ì´ìœ : ${{ needs.orchestrator.outputs.skip_reason }}"
        echo "ğŸ’¡ ê°•ì œ ì‹¤í–‰: workflow_dispatchì—ì„œ modeë¥¼ 'force'ë¡œ ì„¤ì •"
