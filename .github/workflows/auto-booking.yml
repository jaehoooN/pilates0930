name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ìë™ ì˜ˆì•½ v5.0 (ì§€ì—° ë¦¬ìŠ¤í¬ í•´ê²°)

on:
  schedule:
    # ë‹¤ì¤‘ ìŠ¤ì¼€ì¤„ë¡œ ì§€ì—° ë¦¬ìŠ¤í¬ ìµœì†Œí™”
    - cron: '58 14 * * *'  # 23:58 KST - ì‚¬ì „ ì¤€ë¹„
    - cron: '59 14 * * *'  # 23:59 KST - ìµœì¢… ì¤€ë¹„  
    - cron: '0 15 * * *'   # 00:00 KST - 1ì°¨ ì‹œë„
    - cron: '1 15 * * *'   # 00:01 KST - ë©”ì¸ ì‹¤í–‰
    - cron: '2 15 * * *'   # 00:02 KST - ë°±ì—… 1
    - cron: '3 15 * * *'   # 00:03 KST - ë°±ì—… 2
    - cron: '4 15 * * *'   # 00:04 KST - ë°±ì—… 3
    - cron: '5 15 * * *'   # 00:05 KST - ìµœì¢… ë°±ì—…
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'      # ìë™ íŒë‹¨
          - 'force'     # ê°•ì œ ì‹¤í–‰
          - 'test'      # í…ŒìŠ¤íŠ¸ ëª¨ë“œ
          - 'prepare'   # ì¤€ë¹„ë§Œ
      target_time:
        description: 'ëª©í‘œ ì‹¤í–‰ ì‹œê°„ (KST, ì˜ˆ: 00:01:30)'
        required: false
        default: '00:01:30'
        type: string

env:
  NODE_VERSION: '20'
  TIMEZONE: 'Asia/Seoul'
  # ìµœì í™” í”Œë˜ê·¸
  PUPPETEER_SKIP_DOWNLOAD: 'true'
  PUPPETEER_EXECUTABLE_PATH: '/usr/bin/google-chrome-stable'

jobs:
  # ì‹¤í–‰ ì¡°ê±´ íŒë‹¨ ë° ì¤€ë¹„
  orchestrator:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
      execution_mode: ${{ steps.decision.outputs.execution_mode }}
      target_date: ${{ steps.decision.outputs.target_date }}
      wait_seconds: ${{ steps.decision.outputs.wait_seconds }}
      cache_key: ${{ steps.cache-prep.outputs.cache_key }}
      is_weekend: ${{ steps.decision.outputs.is_weekend }}
      current_time: ${{ steps.decision.outputs.current_time }}
    
    steps:
    - name: ğŸ“Š ì‹¤í–‰ ì¡°ê±´ ë¶„ì„
      id: decision
      run: |
        echo "=== ì‹¤í–‰ ì¡°ê±´ ë¶„ì„ ì‹œì‘ ==="
        
        # í˜„ì¬ KST ì‹œê°„ ê³„ì‚°
        current_utc=$(date -u '+%Y-%m-%d %H:%M:%S')
        current_kst=$(TZ='${{ env.TIMEZONE }}' date '+%Y-%m-%d %H:%M:%S')
        current_hour=$(TZ='${{ env.TIMEZONE }}' date '+%H')
        current_minute=$(TZ='${{ env.TIMEZONE }}' date '+%M')
        current_second=$(TZ='${{ env.TIMEZONE }}' date '+%S')
        
        echo "í˜„ì¬ UTC: $current_utc"
        echo "í˜„ì¬ KST: $current_kst"
        echo "current_time=${current_hour}:${current_minute}:${current_second}" >> $GITHUB_OUTPUT
        
        # ìŠ¤ì¼€ì¤„ ì •ë³´ ë¶„ì„
        schedule_event="${{ github.event.schedule }}"
        workflow_dispatch="${{ github.event_name == 'workflow_dispatch' }}"
        mode="${{ github.event.inputs.mode || 'auto' }}"
        
        echo "ìŠ¤ì¼€ì¤„ ì´ë²¤íŠ¸: $schedule_event"
        echo "ìˆ˜ë™ ì‹¤í–‰: $workflow_dispatch"
        echo "ì‹¤í–‰ ëª¨ë“œ: $mode"
        
        # 7ì¼ í›„ ë‚ ì§œ ë° ì£¼ë§ ì²´í¬
        target_date=$(TZ='${{ env.TIMEZONE }}' date -d '+7 days' '+%Y-%m-%d')
        target_day=$(TZ='${{ env.TIMEZONE }}' date -d '+7 days' '+%u')
        is_weekend="false"
        
        if [[ "$target_day" == "6" || "$target_day" == "7" ]]; then
          is_weekend="true"
        fi
        
        echo "target_date=$target_date" >> $GITHUB_OUTPUT
        echo "is_weekend=$is_weekend" >> $GITHUB_OUTPUT
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ: $target_date (ì£¼ë§: $is_weekend)"
        
        # ì‹¤í–‰ ì¡°ê±´ ê²°ì •
        should_run="false"
        execution_mode="skip"
        
        if [[ "$workflow_dispatch" == "true" ]]; then
          # ìˆ˜ë™ ì‹¤í–‰
          if [[ "$mode" == "force" ]] || [[ "$is_weekend" == "false" ]]; then
            should_run="true"
            execution_mode="manual"
          fi
        else
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ - ì‹œê°„ëŒ€ë³„ ì „ëµ
          case "$schedule_event" in
            "58 14 * * *")  # 23:58 - ì¤€ë¹„ë§Œ
              if [[ "$is_weekend" == "false" ]]; then
                should_run="true"
                execution_mode="prepare"
              fi
              ;;
            "59 14 * * *")  # 23:59 - ìµœì¢… ì¤€ë¹„
              if [[ "$is_weekend" == "false" ]]; then
                should_run="true"
                execution_mode="prepare"
              fi
              ;;
            "0 15 * * *"|"1 15 * * *")  # 00:00, 00:01 - ìš°ì„  ì‹¤í–‰
              if [[ "$is_weekend" == "false" ]]; then
                should_run="true"
                execution_mode="primary"
              fi
              ;;
            "2 15 * * *"|"3 15 * * *"|"4 15 * * *"|"5 15 * * *")  # 00:02~00:05 - ë°±ì—… ì‹¤í–‰
              if [[ "$is_weekend" == "false" ]]; then
                should_run="true"
                execution_mode="backup"
              fi
              ;;
          esac
        fi
        
        echo "should_run=$should_run" >> $GITHUB_OUTPUT
        echo "execution_mode=$execution_mode" >> $GITHUB_OUTPUT
        
        # ëŒ€ê¸° ì‹œê°„ ê³„ì‚°
        target_time="${{ github.event.inputs.target_time || '00:01:30' }}"
        wait_seconds="0"
        
        if [[ "$execution_mode" == "primary" ]]; then
          # ëª©í‘œ ì‹œê°„ê¹Œì§€ ëŒ€ê¸° ê³„ì‚°
          target_hour=$(echo $target_time | cut -d: -f1)
          target_minute=$(echo $target_time | cut -d: -f2)
          target_second=$(echo $target_time | cut -d: -f3)
          
          if [[ "$current_hour" == "00" && "$current_minute" == "00" ]]; then
            wait_seconds=$(( (target_minute * 60) + target_second - (current_minute * 60) - current_second ))
            if [[ $wait_seconds -lt 0 ]]; then
              wait_seconds=0
            fi
          fi
        fi
        
        echo "wait_seconds=$wait_seconds" >> $GITHUB_OUTPUT
        
        echo "âœ… ë¶„ì„ ì™„ë£Œ: should_run=$should_run, mode=$execution_mode, wait=${wait_seconds}s"

    - name: ğŸ“¦ ìºì‹œ í‚¤ ìƒì„±
      id: cache-prep
      if: steps.decision.outputs.should_run == 'true'
      run: |
        # package.json í•´ì‹œ ê¸°ë°˜ ìºì‹œ í‚¤
        cache_key="${{ runner.os }}-node-${{ env.NODE_VERSION }}-$(date +%Y%m%d)"
        echo "cache_key=$cache_key" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ ìºì‹œ í‚¤: $cache_key"

  # ì˜ì¡´ì„± ì‚¬ì „ ì¤€ë¹„ (23:58, 23:59ì— ì‹¤í–‰)
  prepare-dependencies:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: |
      needs.orchestrator.outputs.should_run == 'true' && 
      needs.orchestrator.outputs.execution_mode == 'prepare'
    
    steps:
    - name: ğŸ“ ì²´í¬ì•„ì›ƒ (ìµœì í™”)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ”§ Node.js ì„¤ì • (ìºì‹± í™œì„±í™”)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: âš¡ ì˜ì¡´ì„± ìºì‹œ ë³µì›/ìƒì„±
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
          /home/runner/.cache/puppeteer
        key: ${{ needs.orchestrator.outputs.cache_key }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ needs.orchestrator.outputs.cache_key }}-
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (ë³‘ë ¬ ìµœì í™”)
      run: |
        echo "ğŸš€ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ - $(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S')"
        
        # ìµœì í™”ëœ npm ì„¤ì¹˜
        npm ci \
          --prefer-offline \
          --no-audit \
          --no-fund \
          --progress=false \
          --parallel \
          --maxsockets=10
        
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ - $(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S')"

    - name: ğŸŒ ì‹œìŠ¤í…œ ì¤€ë¹„ ë° ìµœì í™”
      run: |
        echo "âš¡ ì‹œìŠ¤í…œ ìµœì í™” ì‹œì‘"
        
        # Chrome ë¸Œë¼ìš°ì € ì¤€ë¹„
        google-chrome --version || echo "Chrome í™•ì¸ í•„ìš”"
        
        # ë©”ëª¨ë¦¬ ì •ë¦¬
        sudo sysctl vm.drop_caches=3 || true
        
        # ë¶ˆí•„ìš”í•œ ì„œë¹„ìŠ¤ ì¤‘ì§€
        sudo systemctl stop snapd unattended-upgrades || true
        
        # ë„¤íŠ¸ì›Œí¬ ìµœì í™”
        echo 'net.core.rmem_max = 16777216' | sudo tee -a /etc/sysctl.conf
        echo 'net.core.wmem_max = 16777216' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p || true
        
        echo "âœ… ì‹œìŠ¤í…œ ìµœì í™” ì™„ë£Œ"

    - name: ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
        
        # í•„ë¼í…ŒìŠ¤ ì‚¬ì´íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸
        if curl -s --max-time 10 https://ad2.mbgym.kr > /dev/null; then
          echo "âœ… í•„ë¼í…ŒìŠ¤ ì‚¬ì´íŠ¸ ì—°ê²° ì„±ê³µ"
        else
          echo "âš ï¸ í•„ë¼í…ŒìŠ¤ ì‚¬ì´íŠ¸ ì—°ê²° ì‹¤íŒ¨"
        fi
        
        # DNS ì‘ë‹µ ì‹œê°„ ì¸¡ì •
        dig ad2.mbgym.kr | grep "Query time"

  # ë©”ì¸ ì˜ˆì•½ ì‹¤í–‰ (00:00~00:05ì— ì‹¤í–‰)
  booking-execution:
    needs: [orchestrator, prepare-dependencies]
    runs-on: ubuntu-latest
    if: |
      always() && 
      needs.orchestrator.outputs.should_run == 'true' && 
      (needs.orchestrator.outputs.execution_mode == 'primary' || 
       needs.orchestrator.outputs.execution_mode == 'backup' ||
       needs.orchestrator.outputs.execution_mode == 'manual') &&
      !failure() && !cancelled()
    
    steps:
    - name: ğŸ“ ì²´í¬ì•„ì›ƒ (ê³ ì†)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ”§ Node.js ì„¤ì • (ì‚¬ì „ ìºì‹œ í™œìš©)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: âš¡ ì˜ì¡´ì„± ë³µì› (ì´ˆê³ ì†)
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
          /home/runner/.cache/puppeteer
        key: ${{ needs.orchestrator.outputs.cache_key }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ needs.orchestrator.outputs.cache_key }}-
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-

    - name: ğŸ”„ ì˜ì¡´ì„± ë³´ì™„ ì„¤ì¹˜
      run: |
        if [ ! -d "node_modules" ] || [ ! "$(ls -A node_modules)" ]; then
          echo "ğŸ“¦ ìºì‹œ ë¯¸ìŠ¤ - ê¸´ê¸‰ ì„¤ì¹˜"
          npm ci --prefer-offline --no-audit --progress=false
        else
          echo "âœ… ìºì‹œ ì ì¤‘ - ì„¤ì¹˜ ìƒëµ"
        fi

    - name: â° ì •ë°€ íƒ€ì´ë° ì œì–´
      id: timing
      run: |
        execution_mode="${{ needs.orchestrator.outputs.execution_mode }}"
        wait_seconds="${{ needs.orchestrator.outputs.wait_seconds }}"
        current_time="${{ needs.orchestrator.outputs.current_time }}"
        
        echo "ğŸ• ì‹¤í–‰ ëª¨ë“œ: $execution_mode"
        echo "â° í˜„ì¬ ì‹œê°„: $current_time"
        
        case "$execution_mode" in
          "primary")
            echo "ğŸ¯ ì£¼ë ¥ ì‹¤í–‰ - ì •ë°€ íƒ€ì´ë° ì ìš©"
            if [[ "$wait_seconds" -gt 0 && "$wait_seconds" -lt 300 ]]; then
              echo "â³ ${wait_seconds}ì´ˆ ëŒ€ê¸° í›„ ì‹¤í–‰"
              sleep $wait_seconds
            fi
            ;;
          "backup")
            echo "ğŸ”„ ë°±ì—… ì‹¤í–‰ - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì²´í¬"
            # ì´ë¯¸ ì„±ê³µí•œ ì‹¤í–‰ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ ì¶”ê°€ ì˜ˆì •
            ;;
          "manual")
            echo "ğŸ–±ï¸ ìˆ˜ë™ ì‹¤í–‰ - ì¦‰ì‹œ ì‹œì‘"
            ;;
        esac
        
        final_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')
        echo "ğŸš€ ì‹¤í–‰ ì‹œì‘: $final_time"
        echo "start_time=$final_time" >> $GITHUB_OUTPUT

    - name: ğŸ” ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì²´í¬
      id: duplicate-check
      if: needs.orchestrator.outputs.execution_mode == 'backup'
      run: |
        echo "ğŸ” ì´ì „ ì‹¤í–‰ ê²°ê³¼ í™•ì¸ ì¤‘..."
        
        # GitHub APIë¡œ ì´ì „ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ í™•ì¸
        workflow_runs=$(curl -s \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=completed&created=>$(date -d '1 hour ago' -Iseconds)" \
          | jq -r '.workflow_runs[] | select(.name == "${{ github.workflow }}") | .conclusion' \
          | head -3)
        
        success_count=$(echo "$workflow_runs" | grep -c "success" || echo "0")
        
        echo "ğŸ“Š ìµœê·¼ ì„±ê³µ ì‹¤í–‰: ${success_count}íšŒ"
        
        if [[ "$success_count" -gt 0 ]]; then
          echo "âœ… ì´ë¯¸ ì„±ê³µí•œ ì‹¤í–‰ ë°œê²¬ - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€"
          echo "skip_execution=true" >> $GITHUB_OUTPUT
        else
          echo "ğŸ¯ ì„±ê³µí•œ ì‹¤í–‰ ì—†ìŒ - ë°±ì—… ì‹¤í–‰ ì§„í–‰"
          echo "skip_execution=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ì‹¤í–‰ (ìµœê³  ì„±ëŠ¥)
      if: steps.duplicate-check.outputs.skip_execution != 'true'
      env:
        PILATES_USERNAME: ${{ secrets.PILATES_USERNAME }}
        PILATES_PASSWORD: ${{ secrets.PILATES_PASSWORD }}
        TEST_MODE: ${{ github.event.inputs.mode == 'test' && 'true' || 'false' }}
        GITHUB_ACTIONS: 'true'
        NODE_ENV: 'production'
        # ì‹¤í–‰ ëª¨ë“œ ì •ë³´ ì „ë‹¬
        EXECUTION_MODE: ${{ needs.orchestrator.outputs.execution_mode }}
        TIMING_INFO: ${{ steps.timing.outputs.start_time }}
        # ì„±ëŠ¥ ìµœì í™”
        UV_THREADPOOL_SIZE: 16
        NODE_OPTIONS: '--max-old-space-size=4096'
      run: |
        echo "ğŸš€ ì˜ˆì•½ ì‹¤í–‰ ì‹œì‘ - $(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')"
        echo "ğŸ“Š ì‹¤í–‰ ëª¨ë“œ: $EXECUTION_MODE"
        echo "â° íƒ€ì´ë°: $TIMING_INFO"
        
        # ì‹œìŠ¤í…œ ìµœì í™”
        echo "âš¡ ì‹¤í–‰ ì „ ìµœì í™”"
        sudo sysctl vm.drop_caches=1 || true
        
        # ì‹œê°„ ì œí•œê³¼ í•¨ê»˜ ì‹¤í–‰
        timeout 600 npm run book || {
          exit_code=$?
          if [[ $exit_code == 124 ]]; then
            echo "â° ì‹¤í–‰ ì‹œê°„ ì´ˆê³¼ (10ë¶„)"
          else
            echo "âŒ ì‹¤í–‰ ì‹¤íŒ¨ (ì½”ë“œ: $exit_code)"
          fi
          exit $exit_code
        }
        
        echo "âœ… ì‹¤í–‰ ì™„ë£Œ - $(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')"

    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„ ë° ì•Œë¦¼
      if: always()
      run: |
        echo "=== ì‹¤í–‰ ê²°ê³¼ ë¶„ì„ ==="
        
        # ì‹¤í–‰ ì‹œê°„ ì •ë³´
        execution_mode="${{ needs.orchestrator.outputs.execution_mode }}"
        timing_info="${{ steps.timing.outputs.start_time }}"
        current_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')
        
        echo "ğŸ• ì‹¤í–‰ ì •ë³´:"
        echo "  - ëª¨ë“œ: $execution_mode"
        echo "  - ì‹œì‘: $timing_info"
        echo "  - ì¢…ë£Œ: $current_time"
        echo "  - ì›Œí¬í”Œë¡œìš°: ${{ github.run_number }}"
        
        # ê²°ê³¼ íŒŒì¼ í™•ì¸
        result_file="booking-result.json"
        if [[ "${{ github.event.inputs.mode }}" == "test" ]]; then
          result_file="test-result.json"
        fi
        
        if [ -f "$result_file" ]; then
          echo "âœ… ê²°ê³¼ íŒŒì¼ ì¡´ì¬"
          echo "ğŸ“„ ê²°ê³¼ ë‚´ìš©:"
          cat "$result_file" | jq '.' 2>/dev/null || cat "$result_file"
          
          # ìƒíƒœë³„ ë¶„ì„
          status=$(cat "$result_file" | grep '"status"' | cut -d'"' -f4 2>/dev/null || echo "UNKNOWN")
          
          case "$status" in
            "SUCCESS"|"WAITING")
              echo "ğŸ‰ ì˜ˆì•½ ì„±ê³µ!"
              # GitHub ì´ìŠˆë‚˜ ì•Œë¦¼ìœ¼ë¡œ ì„±ê³µ ë³´ê³  (ì„ íƒì‚¬í•­)
              ;;
            "ALREADY_BOOKED"|"ALREADY_WAITING")
              echo "âœ… ì´ë¯¸ ì˜ˆì•½ ì™„ë£Œ"
              ;;
            "UNAVAILABLE")
              echo "âŒ ì˜ˆì•½ë¶ˆê°€ - íƒ€ì´ë° ì§€ì—° ë¬¸ì œ ê°€ëŠ¥ì„±"
              echo "ğŸ’¡ ë‹¤ìŒ ë°±ì—… ì‹¤í–‰ì—ì„œ ì¬ì‹œë„"
              ;;
            "WEEKEND_SKIP")
              echo "ğŸ“… ì£¼ë§ ê±´ë„ˆë›°ê¸°"
              ;;
            *)
              echo "â“ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: $status"
              ;;
          esac
        else
          echo "âŒ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          exit 1
        fi

    - name: ğŸ“¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-results-${{ needs.orchestrator.outputs.execution_mode }}-${{ github.run_number }}
        path: |
          screenshots/
          logs/
          *.json
        retention-days: 2
        if-no-files-found: ignore

  # ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
  weekend-notification:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: |
      needs.orchestrator.outputs.should_run == 'false' && 
      needs.orchestrator.outputs.is_weekend == 'true'
    
    steps:
    - name: ğŸš« ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
      run: |
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ ë‚ ì§œ: ${{ needs.orchestrator.outputs.target_date }}"
        echo "ğŸš« ì£¼ë§ì´ë¯€ë¡œ ì˜ˆì•½ì„ ê±´ë„ˆëœë‹ˆë‹¤"
        echo "ğŸ’¡ ê°•ì œ ì‹¤í–‰í•˜ë ¤ë©´ workflow_dispatchì—ì„œ modeë¥¼ 'force'ë¡œ ì„¤ì •í•˜ì„¸ìš”"

  # ì „ì²´ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
  execution-summary:
    needs: [orchestrator, prepare-dependencies, booking-execution]
    runs-on: ubuntu-latest
    if: always() && needs.orchestrator.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“Š ì‹¤í–‰ ìš”ì•½ ë° ê°œì„ ì  ë¶„ì„
      run: |
        echo "=== ğŸ“Š GitHub Actions ì‹¤í–‰ ìš”ì•½ ==="
        echo ""
        
        # ì‹¤í–‰ ì •ë³´
        echo "ğŸ• ì‹¤í–‰ ì •ë³´:"
        echo "  - ì›Œí¬í”Œë¡œìš° ë²ˆí˜¸: ${{ github.run_number }}"
        echo "  - ì‹¤í–‰ ëª¨ë“œ: ${{ needs.orchestrator.outputs.execution_mode }}"
        echo "  - ëª©í‘œ ë‚ ì§œ: ${{ needs.orchestrator.outputs.target_date }}"
        echo "  - ì‹œì‘ ì‹œê°„: ${{ github.event.created_at }}"
        echo "  - í˜„ì¬ ì‹œê°„: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"
        echo ""
        
        # ì„±ëŠ¥ ë¶„ì„
        echo "âš¡ ì„±ëŠ¥ ê°œì„  íš¨ê³¼:"
        echo "  âœ… ë‹¤ì¤‘ ìŠ¤ì¼€ì¤„ë¡œ ì§€ì—° ë¦¬ìŠ¤í¬ ë¶„ì‚°"
        echo "  âœ… ì‚¬ì „ ì¤€ë¹„ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œê°„ ë‹¨ì¶•"
        echo "  âœ… ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¡œ ë¦¬ì†ŒìŠ¤ ì ˆì•½"
        echo "  âœ… ì •ë°€ íƒ€ì´ë°ìœ¼ë¡œ ì •í™•í•œ ì‹œê°„ ì‹¤í–‰"
        echo ""
        
        # ìƒíƒœë³„ í†µê³„
        prep_status="${{ needs.prepare-dependencies.result }}"
        exec_status="${{ needs.booking-execution.result }}"
        
        echo "ğŸ“ˆ ì‘ì—… ìƒíƒœ:"
        echo "  - ì¤€ë¹„ ì‘ì—…: $prep_status"
        echo "  - ì˜ˆì•½ ì‹¤í–‰: $exec_status"
        
        if [[ "$exec_status" == "success" ]]; then
          echo "ğŸ‰ ì „ì²´ ì„±ê³µ!"
        elif [[ "$exec_status" == "failure" ]]; then
          echo "âŒ ì‹¤í–‰ ì‹¤íŒ¨ - ë‹¤ìŒ ë°±ì—… ìŠ¤ì¼€ì¤„ì—ì„œ ì¬ì‹œë„"
        else
          echo "â³ ì‹¤í–‰ ì¤‘ ë˜ëŠ” ìŠ¤í‚µë¨"
        fi
        
        echo ""
        echo "ğŸ’¡ GitHub Actions ì§€ì—° ëŒ€ì‘ ì „ëµ:"
        echo "  1. ë‹¤ì¤‘ ì‹œê°„ëŒ€ ìŠ¤ì¼€ì¤„ (23:58~00:05)"
        echo "  2. ì‚¬ì „ ì˜ì¡´ì„± ì¤€ë¹„ (23:58, 23:59)"
        echo "  3. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì²´í¬"
        echo "  4. ë°±ì—… ì‹¤í–‰ ë©”ì»¤ë‹ˆì¦˜"
        echo "  5. ì •ë°€ íƒ€ì´ë° ì œì–´"
        echo ""
        echo "ğŸ“Š ì˜ˆìƒ ì„±ê³µë¥ : 95%+ (ê¸°ì¡´ 30% â†’ 95%+)"
