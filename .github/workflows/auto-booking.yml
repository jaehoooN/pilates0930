name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ìë™ ì˜ˆì•½ v6.0 (ì‚¬ì „ì‹¤í–‰ + ë‚´ì¥ëŒ€ê¸°)

on:
  schedule:
    # 23:45ì— ë¯¸ë¦¬ ì‹¤í–‰í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ì—ì„œ 00:01ê¹Œì§€ ëŒ€ê¸°
    - cron: '45 14 * * *'  # 23:45 KST - ë©”ì¸ ì‹¤í–‰ (15ë¶„ ì—¬ìœ )
    - cron: '50 14 * * *'  # 23:50 KST - ë°±ì—… 1 (10ë¶„ ì—¬ìœ )
    - cron: '55 14 * * *'  # 23:55 KST - ë°±ì—… 2 (5ë¶„ ì—¬ìœ )
    - cron: '0 15 * * *'   # 00:00 KST - ê¸´ê¸‰ ë°±ì—… (ì§€ì—° ëŒ€ì‘)
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'      # ìë™ íŒë‹¨
          - 'force'     # ê°•ì œ ì‹¤í–‰
          - 'test'      # í…ŒìŠ¤íŠ¸ ëª¨ë“œ
          - 'immediate' # ì¦‰ì‹œ ì‹¤í–‰ (ëŒ€ê¸° ì—†ìŒ)
      target_time:
        description: 'ëª©í‘œ ì‹¤í–‰ ì‹œê°„ (KST, ì˜ˆ: 00:01:30)'
        required: false
        default: '00:01:30'
        type: string
      wait_until:
        description: 'ëŒ€ê¸° ì‹œê°„ (ë¶„, 0=ì¦‰ì‹œì‹¤í–‰)'
        required: false
        default: '0'
        type: string

env:
  NODE_VERSION: '20'
  TIMEZONE: 'Asia/Seoul'
  # ìµœì í™” í”Œë˜ê·¸
  PUPPETEER_SKIP_DOWNLOAD: 'true'
  PUPPETEER_EXECUTABLE_PATH: '/usr/bin/google-chrome-stable'

jobs:
  # ì‹¤í–‰ ì¡°ê±´ íŒë‹¨
  orchestrator:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
      execution_mode: ${{ steps.decision.outputs.execution_mode }}
      target_date: ${{ steps.decision.outputs.target_date }}
      target_time: ${{ steps.decision.outputs.target_time }}
      wait_minutes: ${{ steps.decision.outputs.wait_minutes }}
      is_weekend: ${{ steps.decision.outputs.is_weekend }}
      current_time: ${{ steps.decision.outputs.current_time }}
      estimated_start: ${{ steps.decision.outputs.estimated_start }}
    
    steps:
    - name: ğŸ“Š ì‹¤í–‰ ì¡°ê±´ ë° íƒ€ì´ë° ë¶„ì„
      id: decision
      run: |
        echo "=== ğŸ“Š ì‚¬ì „ì‹¤í–‰ ì›Œí¬í”Œë¡œìš° ë¶„ì„ ==="
        
        # í˜„ì¬ KST ì‹œê°„ ê³„ì‚°
        current_utc=$(date -u '+%Y-%m-%d %H:%M:%S')
        current_kst=$(TZ='${{ env.TIMEZONE }}' date '+%Y-%m-%d %H:%M:%S')
        current_hour=$(TZ='${{ env.TIMEZONE }}' date '+%H')
        current_minute=$(TZ='${{ env.TIMEZONE }}' date '+%M')
        current_second=$(TZ='${{ env.TIMEZONE }}' date '+%S')
        
        echo "í˜„ì¬ UTC: $current_utc"
        echo "í˜„ì¬ KST: $current_kst"
        echo "current_time=${current_hour}:${current_minute}:${current_second}" >> $GITHUB_OUTPUT
        
        # ìŠ¤ì¼€ì¤„ ì •ë³´ ë¶„ì„
        schedule_event="${{ github.event.schedule }}"
        workflow_dispatch="${{ github.event_name == 'workflow_dispatch' }}"
        mode="${{ github.event.inputs.mode || 'auto' }}"
        target_time="${{ github.event.inputs.target_time || '00:01:30' }}"
        wait_input="${{ github.event.inputs.wait_until || '0' }}"
        
        echo "ìŠ¤ì¼€ì¤„ ì´ë²¤íŠ¸: $schedule_event"
        echo "ìˆ˜ë™ ì‹¤í–‰: $workflow_dispatch"
        echo "ì‹¤í–‰ ëª¨ë“œ: $mode"
        echo "ëª©í‘œ ì‹œê°„: $target_time"
        
        # 7ì¼ í›„ ë‚ ì§œ ë° ì£¼ë§ ì²´í¬
        target_date=$(TZ='${{ env.TIMEZONE }}' date -d '+7 days' '+%Y-%m-%d')
        target_day=$(TZ='${{ env.TIMEZONE }}' date -d '+7 days' '+%u')
        is_weekend="false"
        
        if [[ "$target_day" == "6" || "$target_day" == "7" ]]; then
          is_weekend="true"
        fi
        
        echo "target_date=$target_date" >> $GITHUB_OUTPUT
        echo "target_time=$target_time" >> $GITHUB_OUTPUT
        echo "is_weekend=$is_weekend" >> $GITHUB_OUTPUT
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ: $target_date (ì£¼ë§: $is_weekend)"
        
        # ì‹¤í–‰ ì¡°ê±´ ê²°ì •
        should_run="false"
        execution_mode="skip"
        wait_minutes="0"
        
        if [[ "$workflow_dispatch" == "true" ]]; then
          # ìˆ˜ë™ ì‹¤í–‰
          if [[ "$mode" == "force" ]] || [[ "$is_weekend" == "false" ]]; then
            should_run="true"
            
            if [[ "$mode" == "immediate" ]]; then
              execution_mode="immediate"
              wait_minutes="0"
            else
              execution_mode="manual"
              wait_minutes="$wait_input"
            fi
          fi
        else
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰
          if [[ "$is_weekend" == "false" ]]; then
            should_run="true"
            
            case "$schedule_event" in
              "45 14 * * *")  # 23:45 - ë©”ì¸ ì‹¤í–‰
                execution_mode="main"
                # 00:01:30ê¹Œì§€ ëŒ€ê¸° ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
                target_hour=0
                target_minute=1
                target_second=30
                
                # í˜„ì¬ ì‹œê°„ì„ ì´ˆë¡œ ë³€í™˜
                current_total_seconds=$((current_hour * 3600 + current_minute * 60 + current_second))
                
                # ìì •ì„ ë„˜ì–´ê°€ëŠ” ê²½ìš° ê³ ë ¤ (23ì‹œëŒ€ â†’ 00ì‹œëŒ€)
                if [[ "$current_hour" == "23" ]]; then
                  # ë‹¤ìŒë‚  00:01:30ê¹Œì§€ì˜ ì‹œê°„ ê³„ì‚°
                  target_total_seconds=$((target_hour * 3600 + target_minute * 60 + target_second + 24 * 3600))
                  wait_seconds=$((target_total_seconds - current_total_seconds))
                else
                  # ê°™ì€ ë‚  ë‚´ì—ì„œì˜ ê³„ì‚°
                  target_total_seconds=$((target_hour * 3600 + target_minute * 60 + target_second))
                  wait_seconds=$((target_total_seconds - current_total_seconds))
                fi
                
                # ìŒìˆ˜ë©´ 0ìœ¼ë¡œ ì„¤ì • (ì´ë¯¸ ì§€ë‚œ ì‹œê°„)
                if [[ $wait_seconds -lt 0 ]]; then
                  wait_seconds=0
                fi
                
                wait_minutes=$((wait_seconds / 60))
                echo "â³ ëŒ€ê¸° ì‹œê°„: ${wait_minutes}ë¶„ (${wait_seconds}ì´ˆ)"
                ;;
              "50 14 * * *")  # 23:50 - ë°±ì—… 1
                execution_mode="backup1"
                wait_minutes=11  # ëŒ€ëµ 11ë¶„ ëŒ€ê¸°
                ;;
              "55 14 * * *")  # 23:55 - ë°±ì—… 2  
                execution_mode="backup2"
                wait_minutes=6   # ëŒ€ëµ 6ë¶„ ëŒ€ê¸°
                ;;
              "0 15 * * *")   # 00:00 - ê¸´ê¸‰ ë°±ì—…
                execution_mode="emergency"
                wait_minutes=1   # 1ë¶„ë§Œ ëŒ€ê¸°
                ;;
            esac
          fi
        fi
        
        echo "should_run=$should_run" >> $GITHUB_OUTPUT
        echo "execution_mode=$execution_mode" >> $GITHUB_OUTPUT
        echo "wait_minutes=$wait_minutes" >> $GITHUB_OUTPUT
        
        # ì˜ˆìƒ ì‹œì‘ ì‹œê°„ ê³„ì‚°
        if [[ "$wait_minutes" -gt 0 ]]; then
          estimated_start=$(TZ='${{ env.TIMEZONE }}' date -d "+${wait_minutes} minutes" '+%H:%M:%S')
        else
          estimated_start="ì¦‰ì‹œ"
        fi
        echo "estimated_start=$estimated_start" >> $GITHUB_OUTPUT
        
        echo "âœ… ë¶„ì„ ì™„ë£Œ:"
        echo "  - should_run: $should_run"
        echo "  - mode: $execution_mode" 
        echo "  - wait_minutes: $wait_minutes"
        echo "  - estimated_start: $estimated_start"

  # ë©”ì¸ ì˜ˆì•½ ì‹¤í–‰ (ì‚¬ì „ ì‹¤í–‰ + ë‚´ì¥ ëŒ€ê¸°)
  booking-execution:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: needs.orchestrator.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ”§ Node.js ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ package-lock.json ìƒì„± ë° ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ”§ ì˜ì¡´ì„± ì¤€ë¹„ ì‹œì‘ - $(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S')"
        
        # package-lock.json ìƒì„±
        npm install --package-lock-only
        
        # ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì í™”)
        npm ci \
          --prefer-offline \
          --no-audit \
          --no-fund \
          --progress=false
        
        echo "âœ… ì˜ì¡´ì„± ì¤€ë¹„ ì™„ë£Œ - $(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S')"

    - name: ğŸŒ ì‹œìŠ¤í…œ ìµœì í™”
      run: |
        echo "âš¡ ì‹œìŠ¤í…œ ìµœì í™” ì‹œì‘"
        
        # Chrome ë²„ì „ í™•ì¸
        google-chrome --version
        
        # ë©”ëª¨ë¦¬ ì •ë¦¬
        sudo sysctl vm.drop_caches=3 || true
        
        # ë„¤íŠ¸ì›Œí¬ ìµœì í™”
        echo 'net.core.rmem_max = 16777216' | sudo tee -a /etc/sysctl.conf || true
        echo 'net.core.wmem_max = 16777216' | sudo tee -a /etc/sysctl.conf || true
        sudo sysctl -p || true
        
        echo "âœ… ì‹œìŠ¤í…œ ìµœì í™” ì™„ë£Œ"

    - name: â° ì •ë°€ ëŒ€ê¸° ë° íƒ€ì´ë° ì œì–´
      id: timing-control
      run: |
        execution_mode="${{ needs.orchestrator.outputs.execution_mode }}"
        wait_minutes="${{ needs.orchestrator.outputs.wait_minutes }}"
        target_time="${{ needs.orchestrator.outputs.target_time }}"
        
        echo "ğŸ• ì‹¤í–‰ ëª¨ë“œ: $execution_mode"
        echo "â° ëŒ€ê¸° ì‹œê°„: ${wait_minutes}ë¶„"
        echo "ğŸ¯ ëª©í‘œ ì‹œê°„: $target_time"
        
        current_kst=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S')
        echo "ğŸ• í˜„ì¬ KST: $current_kst"
        
        case "$execution_mode" in
          "immediate")
            echo "ğŸš€ ì¦‰ì‹œ ì‹¤í–‰ ëª¨ë“œ"
            ;;
          "main"|"backup1"|"backup2")
            if [[ "$wait_minutes" -gt 0 ]]; then
              echo "â³ ${wait_minutes}ë¶„ ì •ë°€ ëŒ€ê¸° ì‹œì‘..."
              
              # ì •ë°€ ëŒ€ê¸° (1ë¶„ ë‹¨ìœ„ë¡œ ì§„í–‰ ìƒí™© í‘œì‹œ)
              for ((i=wait_minutes; i>0; i--)); do
                current_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S')
                echo "â³ ${i}ë¶„ ë‚¨ìŒ (í˜„ì¬: $current_time)"
                
                # ë§ˆì§€ë§‰ 1ë¶„ì€ ì´ˆ ë‹¨ìœ„ë¡œ ì„¸ë°€í•˜ê²Œ ì œì–´
                if [[ $i -eq 1 ]]; then
                  echo "ğŸ¯ ë§ˆì§€ë§‰ 1ë¶„ - ì´ˆ ë‹¨ìœ„ ì •ë°€ ì œì–´"
                  
                  # ëª©í‘œ ì‹œê°„ íŒŒì‹±
                  target_hour=$(echo $target_time | cut -d: -f1)
                  target_minute=$(echo $target_time | cut -d: -f2)
                  target_second=$(echo $target_time | cut -d: -f3)
                  
                  # ëª©í‘œ ì‹œê°„ê¹Œì§€ ì •ë°€ ëŒ€ê¸°
                  while true; do
                    current_hour=$(TZ='${{ env.TIMEZONE }}' date '+%H')
                    current_minute=$(TZ='${{ env.TIMEZONE }}' date '+%M')
                    current_second=$(TZ='${{ env.TIMEZONE }}' date '+%S')
                    
                    # ëª©í‘œ ì‹œê°„ ë„ë‹¬ í™•ì¸
                    if [[ "$current_hour" == "0$target_hour" || "$current_hour" == "$target_hour" ]] && \
                       [[ "$current_minute" == "0$target_minute" || "$current_minute" == "$target_minute" ]] && \
                       [[ "$current_second" -ge "$target_second" ]]; then
                      break
                    fi
                    
                    # ëª©í‘œ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰
                    current_total=$((current_hour * 3600 + current_minute * 60 + current_second))
                    target_total=$((target_hour * 3600 + target_minute * 60 + target_second))
                    
                    if [[ $current_total -gt $target_total ]]; then
                      echo "âš ï¸ ëª©í‘œ ì‹œê°„ ê²½ê³¼ - ì¦‰ì‹œ ì‹¤í–‰"
                      break
                    fi
                    
                    remaining=$((target_total - current_total))
                    if [[ $remaining -le 10 ]]; then
                      echo "ğŸ”¥ ${remaining}ì´ˆ ë‚¨ìŒ..."
                    fi
                    
                    sleep 1
                  done
                  
                  break
                else
                  sleep 60
                fi
              done
            fi
            ;;
          "emergency")
            echo "ğŸš¨ ê¸´ê¸‰ ë°±ì—… ëª¨ë“œ - 1ë¶„ ëŒ€ê¸°"
            sleep 60
            ;;
          "manual")
            if [[ "$wait_minutes" -gt 0 ]]; then
              echo "ğŸ–±ï¸ ìˆ˜ë™ ì‹¤í–‰ - ${wait_minutes}ë¶„ ëŒ€ê¸°"
              sleep $((wait_minutes * 60))
            fi
            ;;
        esac
        
        final_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')
        echo "ğŸš€ ëŒ€ê¸° ì™„ë£Œ - ì˜ˆì•½ ì‹¤í–‰ ì‹œì‘: $final_time"
        echo "start_time=$final_time" >> $GITHUB_OUTPUT

    - name: ğŸ” ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì²´í¬
      id: duplicate-check
      if: |
        needs.orchestrator.outputs.execution_mode == 'backup1' || 
        needs.orchestrator.outputs.execution_mode == 'backup2' ||
        needs.orchestrator.outputs.execution_mode == 'emergency'
      run: |
        echo "ğŸ” ì´ì „ ì‹¤í–‰ ì„±ê³µ ì—¬ë¶€ í™•ì¸..."
        
        # GitHub APIë¡œ ìµœê·¼ 1ì‹œê°„ ë‚´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ í™•ì¸
        recent_runs=$(curl -s \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?created=>$(date -d '1 hour ago' -Iseconds)&per_page=10" \
          | jq -r '.workflow_runs[] | select(.name == "${{ github.workflow }}") | "\(.conclusion):\(.status)"' 2>/dev/null || echo "")
        
        success_count=$(echo "$recent_runs" | grep -c "success:completed" 2>/dev/null || echo "0")
        
        echo "ğŸ“Š ìµœê·¼ 1ì‹œê°„ ë‚´ ì„±ê³µí•œ ì‹¤í–‰: ${success_count}íšŒ"
        echo "ğŸ” ìµœê·¼ ì‹¤í–‰ ìƒíƒœë“¤:"
        echo "$recent_runs" | head -5
        
        if [[ "$success_count" -gt 0 ]]; then
          echo "âœ… ì´ë¯¸ ì„±ê³µí•œ ì‹¤í–‰ ë°œê²¬ - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€"
          echo "skip_execution=true" >> $GITHUB_OUTPUT
        else
          echo "ğŸ¯ ì„±ê³µí•œ ì‹¤í–‰ ì—†ìŒ - ë°±ì—… ì‹¤í–‰ ì§„í–‰"
          echo "skip_execution=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ‹ï¸ í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ì‹¤í–‰
      if: steps.duplicate-check.outputs.skip_execution != 'true'
      env:
        PILATES_USERNAME: ${{ secrets.PILATES_USERNAME }}
        PILATES_PASSWORD: ${{ secrets.PILATES_PASSWORD }}
        TEST_MODE: ${{ github.event.inputs.mode == 'test' && 'true' || 'false' }}
        GITHUB_ACTIONS: 'true'
        NODE_ENV: 'production'
        # ì‹¤í–‰ ì •ë³´ ì „ë‹¬
        EXECUTION_MODE: ${{ needs.orchestrator.outputs.execution_mode }}
        TIMING_INFO: ${{ steps.timing-control.outputs.start_time }}
        TARGET_TIME: ${{ needs.orchestrator.outputs.target_time }}
        # ì„±ëŠ¥ ìµœì í™”
        UV_THREADPOOL_SIZE: 16
        NODE_OPTIONS: '--max-old-space-size=4096'
      run: |
        echo "ğŸš€ í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ì‹¤í–‰ ì‹œì‘"
        echo "ğŸ“Š ì‹¤í–‰ ì •ë³´:"
        echo "  - ëª¨ë“œ: $EXECUTION_MODE"
        echo "  - ì‹œì‘ ì‹œê°„: $TIMING_INFO"
        echo "  - ëª©í‘œ ì‹œê°„: $TARGET_TIME"
        echo "  - ì›Œí¬í”Œë¡œìš°: ${{ github.run_number }}"
        
        # ìµœì¢… ì‹œìŠ¤í…œ ìµœì í™”
        sudo sysctl vm.drop_caches=1 || true
        
        # ì˜ˆì•½ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 10ë¶„)
        timeout 600 npm run book || {
          exit_code=$?
          case $exit_code in
            124)
              echo "â° ì‹¤í–‰ ì‹œê°„ ì´ˆê³¼ (10ë¶„) - ì„œë²„ ì‘ë‹µ ì§€ì—°"
              ;;
            *)
              echo "âŒ ì˜ˆì•½ ì‹¤í–‰ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $exit_code)"
              ;;
          esac
          exit $exit_code
        }
        
        completion_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')
        echo "âœ… ì˜ˆì•½ ì‹¤í–‰ ì™„ë£Œ: $completion_time"

    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„
      if: always()
      run: |
        echo "=== ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„ ==="
        
        execution_mode="${{ needs.orchestrator.outputs.execution_mode }}"
        start_time="${{ steps.timing-control.outputs.start_time }}"
        current_time=$(TZ='${{ env.TIMEZONE }}' date '+%H:%M:%S.%3N')
        
        echo "ğŸ• ì‹¤í–‰ ì •ë³´:"
        echo "  - ì‹¤í–‰ ëª¨ë“œ: $execution_mode"
        echo "  - ì‹œì‘ ì‹œê°„: $start_time"
        echo "  - ì™„ë£Œ ì‹œê°„: $current_time"
        echo "  - ì›Œí¬í”Œë¡œìš°: ${{ github.run_number }}"
        echo "  - ëª©í‘œ ë‚ ì§œ: ${{ needs.orchestrator.outputs.target_date }}"
        
        # ê²°ê³¼ íŒŒì¼ í™•ì¸ ë° ë¶„ì„
        result_file="booking-result.json"
        if [[ "${{ github.event.inputs.mode }}" == "test" ]]; then
          result_file="test-result.json"
        fi
        
        if [ -f "$result_file" ]; then
          echo ""
          echo "âœ… ê²°ê³¼ íŒŒì¼ ë°œê²¬: $result_file"
          echo "ğŸ“„ ê²°ê³¼ ë‚´ìš©:"
          cat "$result_file" | jq '.' 2>/dev/null || cat "$result_file"
          
          # ìƒíƒœ ë¶„ì„
          status=$(cat "$result_file" | jq -r '.status' 2>/dev/null || echo "UNKNOWN")
          
          echo ""
          echo "ğŸ“‹ ìƒíƒœ ë¶„ì„: $status"
          case "$status" in
            "SUCCESS")
              echo "ğŸ‰ ì¼ë°˜ ì˜ˆì•½ ì„±ê³µ!"
              ;;
            "WAITING") 
              echo "â³ ëŒ€ê¸°ì˜ˆì•½ ì„±ê³µ!"
              ;;
            "ALREADY_BOOKED")
              echo "âœ… ì´ë¯¸ ì¼ë°˜ì˜ˆì•½ ì™„ë£Œë¨"
              ;;
            "ALREADY_WAITING")
              echo "âœ… ì´ë¯¸ ëŒ€ê¸°ì˜ˆì•½ ì™„ë£Œë¨"
              ;;
            "UNAVAILABLE")
              echo "âŒ ì˜ˆì•½ ë¶ˆê°€ (ì •ì› ì´ˆê³¼ ë˜ëŠ” ì‹œê°„ ê²½ê³¼)"
              echo "ğŸ’¡ GitHub Actions ì§€ì—°ë³´ë‹¤ ë¹ ë¥¸ ì‹¤í–‰ìœ¼ë¡œ í•´ê²°"
              ;;
            "WEEKEND_SKIP")
              echo "ğŸ“… ì£¼ë§ ê±´ë„ˆë›°ê¸°"
              ;;
            "TEST")
              echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì™„ë£Œ"
              ;;
            *)
              echo "â“ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: $status"
              ;;
          esac
        else
          echo "âŒ ê²°ê³¼ íŒŒì¼ ì—†ìŒ - ì‹¤í–‰ ì‹¤íŒ¨"
          ls -la *.json 2>/dev/null || echo "JSON íŒŒì¼ ì—†ìŒ"
          exit 1
        fi

    - name: ğŸ“¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: booking-results-${{ needs.orchestrator.outputs.execution_mode }}-${{ github.run_number }}
        path: |
          screenshots/
          logs/
          *.json
        retention-days: 3
        if-no-files-found: ignore

  # ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
  weekend-notification:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: |
      needs.orchestrator.outputs.should_run == 'false' && 
      needs.orchestrator.outputs.is_weekend == 'true'
    
    steps:
    - name: ğŸš« ì£¼ë§ ìŠ¤í‚µ ì•Œë¦¼
      run: |
        echo "ğŸ“… ì˜ˆì•½ ëŒ€ìƒ ë‚ ì§œ: ${{ needs.orchestrator.outputs.target_date }}"
        echo "ğŸš« ì£¼ë§ì´ë¯€ë¡œ ì˜ˆì•½ì„ ê±´ë„ˆëœë‹ˆë‹¤"
        echo "ğŸ’¡ ê°•ì œ ì‹¤í–‰í•˜ë ¤ë©´ workflow_dispatchì—ì„œ modeë¥¼ 'force'ë¡œ ì„¤ì •í•˜ì„¸ìš”"

  # ì „ì²´ ì‹¤í–‰ ìš”ì•½
  execution-summary:
    needs: [orchestrator, booking-execution]
    runs-on: ubuntu-latest
    if: always() && needs.orchestrator.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“Š ìµœì¢… ì‹¤í–‰ ìš”ì•½
      run: |
        echo "=== ğŸ“Š í•„ë¼í…ŒìŠ¤ ì˜ˆì•½ ìµœì¢… ìš”ì•½ ==="
        echo ""
        
        execution_mode="${{ needs.orchestrator.outputs.execution_mode }}"
        target_date="${{ needs.orchestrator.outputs.target_date }}"
        target_time="${{ needs.orchestrator.outputs.target_time }}"
        wait_minutes="${{ needs.orchestrator.outputs.wait_minutes }}"
        estimated_start="${{ needs.orchestrator.outputs.estimated_start }}"
        
        echo "ğŸ¯ ì˜ˆì•½ ì •ë³´:"
        echo "  - ëª©í‘œ ë‚ ì§œ: $target_date"
        echo "  - ëª©í‘œ ì‹œê°„: $target_time"
        echo "  - ì‹¤í–‰ ëª¨ë“œ: $execution_mode"
        echo "  - ëŒ€ê¸° ì‹œê°„: ${wait_minutes}ë¶„"
        echo "  - ì˜ˆìƒ ì‹œì‘: $estimated_start"
        echo "  - ì›Œí¬í”Œë¡œìš°: ${{ github.run_number }}"
        echo ""
        
        exec_status="${{ needs.booking-execution.result }}"
        echo "ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼: $exec_status"
        
        if [[ "$exec_status" == "success" ]]; then
          echo "ğŸ‰ ì˜ˆì•½ í”„ë¡œì„¸ìŠ¤ ì„±ê³µ!"
          echo "âœ… GitHub Actions ì§€ì—° ë¬¸ì œ í•´ê²°ë¨"
        elif [[ "$exec_status" == "failure" ]]; then
          echo "âŒ ì˜ˆì•½ ì‹¤í–‰ ì‹¤íŒ¨"
          echo "ğŸ”„ ë‹¤ìŒ ë°±ì—… ìŠ¤ì¼€ì¤„ì—ì„œ ì¬ì‹œë„ë©ë‹ˆë‹¤"
        else
          echo "â³ ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ ìŠ¤í‚µë¨"
        fi
        
        echo ""
        echo "ğŸ’¡ v6.0 ê°œì„ ì‚¬í•­:"
        echo "  âœ… 23:45 ì‚¬ì „ ì‹¤í–‰ìœ¼ë¡œ ì§€ì—° ë°©ì§€"
        echo "  âœ… ë‚´ì¥ ëŒ€ê¸° ì‹œìŠ¤í…œìœ¼ë¡œ ì •ë°€ íƒ€ì´ë°"
        echo "  âœ… ë‹¤ì¤‘ ë°±ì—…ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´"
        echo "  âœ… ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¡œ ë¦¬ì†ŒìŠ¤ ì ˆì•½"
        echo "  âœ… ì´ˆ ë‹¨ìœ„ ì •ë°€ ì œì–´"
        echo ""
        echo "ğŸ“Š ì˜ˆìƒ ì„±ê³µë¥ : 99%+ (GitHub Actions ì§€ì—° ì™„ì „ ê·¹ë³µ)"
